// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
}

model User {
  id              String   @id @default(cuid())
  name            String?
  email           String?  @unique
  emailVerified   DateTime?
  image           String?
  avatarUrl       String?  // S3 avatar URL
  membershipTier  String   @default("tier1") // Tier IDs match config
  stripeCustomerId String?
  stripePriceId   String?  // Current subscription price ID
  lastLoginAt     DateTime?
  createdAt       DateTime @default(now())

  accounts Account[]
  sessions Session[]
  subscriptions Subscription[]
  adminActivityLogs AdminActivityLog[] @relation("AdminUser")
  targetActivityLogs AdminActivityLog[] @relation("TargetUser")
  adminImpersonations AdminImpersonation[] @relation("AdminImpersonations")
  targetImpersonations AdminImpersonation[] @relation("TargetImpersonations")
  notifications Notification[]
  apiTokens ApiToken[]

  @@index([membershipTier])
  @@index([stripeCustomerId])
  @@index([createdAt])
}

model Account {
  id                String  @id @default(cuid())
  userId            String
  type              String
  provider          String
  providerAccountId String
  refresh_token     String?
  access_token      String?
  expires_at        Int?
  token_type        String?
  scope             String?
  id_token          String?
  session_state     String?

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
}

model Session {
  id           String   @id @default(cuid())
  sessionToken String   @unique
  userId       String
  expires      DateTime

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model VerificationToken {
  identifier String
  token      String   @unique
  expires    DateTime

  @@unique([identifier, token])
}

model PortalConfigModel {
  id        String   @id
  name      String
  preset    String // "generic" | "campus-sound" | future
  data      Json    // Serialized PortalConfig
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model Subscription {
  id                String   @id @default(cuid())
  userId            String
  stripeCustomerId  String
  stripeSubscriptionId String
  stripePriceId     String
  status            String   @default("active") // active, past_due, canceled
  currentTier       String   // Tier name (tier1, tier2, tier3, tier4)
  startDate         DateTime
  renewalDate       DateTime?
  canceledAt        DateTime?
  reminderSentAt    DateTime? // Track if 7-day renewal reminder was sent
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([stripeSubscriptionId])
  @@index([status])
  @@index([renewalDate])
  @@index([userId, status])
}

model AdminActivityLog {
  id            String   @id @default(cuid())
  adminId       String
  action        String   // e.g., "UPDATE_TIER", "DELETE_USER", "BULK_DELETE"
  targetUserId  String?
  details       Json?    // Additional context
  createdAt     DateTime @default(now())

  admin       User  @relation("AdminUser", fields: [adminId], references: [id], onDelete: Cascade)
  targetUser  User? @relation("TargetUser", fields: [targetUserId], references: [id], onDelete: SetNull)

  @@index([adminId])
  @@index([targetUserId])
  @@index([createdAt])
  @@map("admin_activity_logs")
}

model AdminImpersonation {
  id            String    @id @default(cuid())
  adminId       String
  targetUserId  String
  startedAt     DateTime  @default(now())
  endedAt       DateTime?
  expiresAt     DateTime

  admin       User @relation("AdminImpersonations", fields: [adminId], references: [id], onDelete: Cascade)
  targetUser  User @relation("TargetImpersonations", fields: [targetUserId], references: [id], onDelete: Cascade)

  @@index([adminId])
  @@index([targetUserId])
  @@map("admin_impersonations")
}

model Notification {
  id        String   @id @default(cuid())
  userId    String
  subject   String
  message   String
  type      String   @default("info") // info, warning, error, success
  read      Boolean  @default(false)
  createdAt DateTime @default(now())

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId, read])
  @@map("notifications")
}

model ApiToken {
  id          String    @id @default(cuid())
  userId      String
  name        String    // User-friendly name for the token
  token       String    @unique // Hashed token
  scopes      String[]  // Permissions: ["read:profile", "write:subscriptions"]
  lastUsedAt  DateTime?
  expiresAt   DateTime?
  createdAt   DateTime  @default(now())

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([token])
  @@index([userId, expiresAt])
  @@index([lastUsedAt])
  @@map("api_tokens")
}
// ============================================================================
// STUDIO FEATURES - Color Management & Theming
// ============================================================================

model StudioTheme {
  id              String   @id @default(cuid())
  configId        String
  name            String
  description     String?
  primaryColor    String   @default("#3B82F6")
  secondaryColor  String   @default("#8B5CF6")
  accentColor     String   @default("#EC4899")
  backgroundColor String   @default("#FFFFFF")
  textColor       String   @default("#1F2937")
  borderColor     String   @default("#E5E7EB")
  
  // Additional CSS variables stored as JSON
  variables       Json? // { "--custom-spacing": "4px", ... }
  
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  @@index([configId])
  @@map("studio_themes")
}

// ============================================================================
// STUDIO FEATURES - Asset Management (Images/Media)
// ============================================================================

model StudioAsset {
  id          String   @id @default(cuid())
  configId    String
  name        String
  type        String   // "image" | "video" | "icon" | "logo"
  url         String   // S3 or CDN URL
  thumbnailUrl String?
  size        Int      // File size in bytes
  mimeType    String
  width       Int?
  height      Int?
  metadata    Json?    // Additional metadata
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([configId])
  @@index([type])
  @@map("studio_assets")
}

// ============================================================================
// STUDIO FEATURES - Team & Contacts Management
// ============================================================================

model StudioContact {
  id          String   @id @default(cuid())
  configId    String
  firstName   String
  lastName    String
  email       String
  phone       String?
  role        String?  // "designer" | "developer" | "manager" | "contributor"
  avatar      String?  // S3 URL
  bio         String?
  notes       String?
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  messages    StudioMessage[] @relation("ContactMessages")
  receivedMessages StudioMessage[] @relation("RecipientMessages")

  @@index([configId])
  @@index([email])
  @@map("studio_contacts")
}

// ============================================================================
// STUDIO FEATURES - Messaging & Collaboration
// ============================================================================

model StudioMessage {
  id          String   @id @default(cuid())
  configId    String
  fromContactId String
  toContactId String
  subject     String?
  content     String   // Markdown support
  attachments Json?    // Array of attachment URLs
  
  read        Boolean  @default(false)
  readAt      DateTime?
  starred     Boolean  @default(false)
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  fromContact StudioContact @relation("ContactMessages", fields: [fromContactId], references: [id], onDelete: Cascade)
  toContact   StudioContact @relation("RecipientMessages", fields: [toContactId], references: [id], onDelete: Cascade)

  @@index([configId])
  @@index([fromContactId])
  @@index([toContactId])
  @@index([read])
  @@map("studio_messages")
}

// ============================================================================
// STUDIO FEATURES - Feature Development & Timeline
// ============================================================================

model StudioFeature {
  id            String   @id @default(cuid())
  configId      String
  name          String
  description   String?
  status        String   @default("planning") // planning | in-progress | review | completed
  priority      String   @default("medium") // low | medium | high | critical
  dueDate       DateTime?
  
  // Implementation details
  componentCode String? // Generated code
  generatedBy   String? // "gemini" | "manual"
  
  // Timeline tracking
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
  completedAt   DateTime?

  timeline      StudioTimeline[]

  @@index([configId])
  @@index([status])
  @@index([priority])
  @@map("studio_features")
}

// ============================================================================
// STUDIO FEATURES - Activity & Change Timeline
// ============================================================================

model StudioTimeline {
  id            String   @id @default(cuid())
  configId      String
  featureId     String?
  action        String   // "created" | "updated" | "deleted" | "deployed" | "ai_generated"
  description   String
  changes       Json?    // Diff or change details
  
  metadata      Json?    // Additional context (user, location, etc.)
  
  createdAt     DateTime @default(now())

  feature       StudioFeature? @relation(fields: [featureId], references: [id], onDelete: SetNull)

  @@index([configId])
  @@index([featureId])
  @@index([action])
  @@index([createdAt])
  @@map("studio_timeline")
}

// ============================================================================
// STUDIO FEATURES - Generated Code Components
// ============================================================================

model StudioComponent {
  id            String   @id @default(cuid())
  configId      String
  name          String
  description   String?
  category      String   // "button" | "card" | "form" | "layout" | "navigation"
  
  // Code generation
  code          String   // React component code
  generatedFrom String?  // Prompt or feature ID
  generatedBy   String?  // "gemini" | "template"
  
  // Metadata
  version       String   @default("1.0.0")
  dependencies  Json?    // Required packages
  props         Json?    // Component prop definitions
  examples      Json?    // Usage examples
  
  featured      Boolean  @default(false)
  
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  @@index([configId])
  @@index([category])
  @@index([featured])
  @@map("studio_components")
}

// ============================================================================
// STUDIO FEATURES - AI Chat History
// ============================================================================

model StudioAIChat {
  id            String   @id @default(cuid())
  configId      String
  title         String?  // Chat session title
  
  messages      Json    // Array of { role, content, timestamp }
  context       Json?   // Context about what's being discussed
  
  generatedCount Int @default(0) // Number of components/features generated
  
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  @@index([configId])
  @@index([createdAt])
  @@map("studio_ai_chats")
}